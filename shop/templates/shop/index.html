<!-- I HAVE TO CREATE THE MY CART PAGE  -->

{% extends 'shop/base.html' %}
{% load static %}

{% block css %}

.col-md-3 img {
width: 100%;
height: 225px;
object-fit: cover;
}

.card-text{
display: -webkit-box;
-webkit-line-clamp: 2;
-webkit-box-orient: vertical;
overflow: hidden;
min-height: 50px;
}



body .carousel-indicators button {
background-color: blue;
}

.carousel-indicators .active {
background-color: blue;
}

.carousel-control-prev-icon,
.carousel-control-next-icon
{
filter: invert(1);
}

.cart {
position: relative;
z-index: 9999;
}


.carousel {
position: relative;
}

/* arrows ko overlay se bahar nikalo */
.carousel-control-prev,
.carousel-control-next {
top: 50% !important;
bottom: auto !important;
height: 50px !important;
width: 50px !important;
transform: translateY(-50%) !important;
background: white !important;
border-radius: 50% !important;
opacity: 1 !important;
}



.carousel-control-prev {
left:-100px !important
}

.carousel-control-next {
right: -100px; !important
}


.carousel-control-prev-icon,
.carousel-control-next-icon {
filter: invert(1);
}

body .no-padding {
padding-left: 0;
padding-right: 0;
}

.carousel {
overflow: visible;
}

.carousel-control-prev {
left: -50px !important;
}

.carousel-control-next {
right: -50px !important;
}

.carousel-control-prev {
left: -60px !important;
}

.carousel-control-next {
right: -60px !important;
}

.carousel {
overflow: visible !important;
}


{% endblock %}

<!-- hero-section -->
{% block hero%}
{% endblock %}

{% block body %}

<div class="container">

  {% for product, range, nslides in allprod %}

  <h2 class="my-4">{{ product.0.category }}</h2>

  <div id="demo{{ forloop.counter }}" class="carousel slide mb-5" data-bs-ride="carousel">

    <div class="carousel-inner">

      {% for i in product %}

      {% if forloop.counter0|divisibleby:4 %}
      <div class="carousel-item {% if forloop.counter0 == 0 %}active{% endif %}">
        <div class="row">
          {% endif %}

          <div class="col-12 col-sm-6 col-md-3 mb-4">
            <div class="card h-100">

              <img src="{{ i.image.url }}" class="card-img-top" style="height: 225px; object-fit: cover;">

              <div class="card-body d-flex flex-column">

                <h4 class="card-title" id="namepr{{i.id}}">
                  {{ i.product_name|truncatewords:12 }}
                </h4>
                
                <h5 class="card-price" id="pricepr{{i.id}}">
                 Rs. <span>{{ i.price|truncatewords:12 }}</span>
                </h5>

                <p class="card-text">
                  {{ i.desc|truncatewords:12 }}
                </p>

                <div class="mt-auto">
                  <span id="divpr{{i.id}}">
                    <button id="pr{{i.id}}" class="btn btn-primary add-cart">
                      Add To Cart
                    </button>
                  </span>

                  <a href="/shop/products/{{i.id}}" class="btn btn-primary">
                    QuickView
                  </a>
                </div>

              </div>
            </div>
          </div>

          {% if forloop.counter|divisibleby:4 or forloop.last %}
        </div>
      </div>
      {% endif %}

      {% endfor %}

    </div>

    <!-- Controls -->
    <button class="carousel-control-prev" type="button" data-bs-target="#demo{{ forloop.counter }}"
      data-bs-slide="prev">
      <span class="carousel-control-prev-icon"></span>
    </button>

    <button class="carousel-control-next" type="button" data-bs-target="#demo{{ forloop.counter }}"
      data-bs-slide="next">
      <span class="carousel-control-next-icon"></span>
    </button>

  </div>

  {% endfor %}

</div>

{% endblock %}



{% block js %}

<script>
  let cart = {};

  try {
    let storedCart = localStorage.getItem("cart");
    if (storedCart) {
      cart = JSON.parse(storedCart);
    }
  } catch (e) {
    cart = {};
    localStorage.setItem("cart", JSON.stringify(cart));
  }

  document.getElementById("cart").innerHTML = Object.keys(cart).length;


  $(document).on("click", ".add-cart", function () {
    let id = this.id;
    name = document.getElementById('name' + id).innerHTML;
    price = document.querySelector('#price' + id + ' span').innerText;

    if (cart[id] == undefined) {
      qty = 1;
      cart[id] = [qty, name , parseInt(price)];
    } else {
      qty = cart[id][0] += 1;
    }

    updateCart(cart);
  });


  function updateCart(cart) {
    for (let item in cart) {
      let div = document.getElementById("div" + item);
      if (!div) continue;

      div.innerHTML =
        `<button id="minus${item}" class="btn btn-primary minus">-</button>
         <span id="val${item}"> ${cart[item][0]} </span>
         <button id="plus${item}" class="btn btn-primary plus">+</button>`;
    }

    localStorage.setItem("cart", JSON.stringify(cart));
    document.getElementById("cart").innerHTML = Object.keys(cart).length;

    updatePopover(cart);
  }

  $(document).on("click", ".plus", function () {
    let id = this.id.replace("plus", "");
    cart[id][0] += 1;
    updateCart(cart);
  });

  $(document).on("click", ".minus", function () {

    let id = this.id.replace("minus", "");

    cart[id][0] -= 1;

    if (cart[id][0] <= 0) {

      delete cart[id];

      document.getElementById("div" + id).innerHTML =
        `<button id="${id}" class="btn btn-primary add-cart">Add To Cart</button>`;
    }

    updateCart(cart);
  });

  let popcart = document.getElementById("popcart");

  function updatePopover(cart) {
    let popStr = "<h5>These are the items in your cart</h5>";
    let i = 1;

    for (let item in cart) {
      let nameElem = document.getElementById("name" + item);
      if (!nameElem) continue;

      popStr += `<b>${i}</b>. <b>${cart[item][2]}</b> ${nameElem.innerHTML} | Qty: ${cart[item][0]}<br>`;
      i++;
    }
    popStr += `
    <hr>
    <a href="/shop/checkout" class="btn btn-primary btn-sm me-2">Checkout</a>
     <a href="javascript:void(0)" onclick='clearcart()' id="clearCart" class="btn btn-danger btn-sm">Clear Cart</a>
  `;
    popcart.setAttribute("data-bs-content", popStr);

    let popover = new bootstrap.Popover(popcart, {
      html: true,
      trigger: "click",
      placement: "bottom"
    });

    popover.show();
  }

  updatePopover(cart);

  function clearcart() {
    cart = {};
    localStorage.removeItem('cart');
    document.getElementById("cart").innerHTML = 0;

    updatePopover(cart);
  }
</script>


{% endblock %}